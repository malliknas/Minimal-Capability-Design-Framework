<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCD Simulation Runner</title>
<style>
        /* 🎨 COMPREHENSIVE STYLES - Base + Appendix-Style Component Support */
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #2c3e50;
            line-height: 1.6;
        }

        /* ============================================== */
        /* ANIMATIONS & KEYFRAMES */
        /* ============================================== */
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideInFromBottom {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ============================================== */
        /* GLOBAL BUTTON STYLES */
        /* ============================================== */
        
        /* Button state management with visual feedback */
        .btn-loading {
            position: relative;
            color: transparent !important;
            pointer-events: none;
        }

        .btn-loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            color: white;
        }

        /* Success/Error state indicators */
        .execution-success {
            border-left: 4px solid #4caf50 !important;
            background: linear-gradient(135deg, #f8fff8 0%, #f0fff0 100%) !important;
        }

        .execution-error {
            border-left: 4px solid #f44336 !important;
            background: linear-gradient(135deg, #fff5f5 0%, #ffeaea 100%) !important;
        }
/* ✅ ADD: Visual button state protection */
button.executing {
    opacity: 0.6;
    pointer-events: none;
    cursor: not-allowed;
}

button.executing::after {
    content: ' (Running...)';
    font-size: 0.8rem;
    opacity: 0.7;
}

/* ✅ ADD: Walkthrough-specific button protection */
.start-walkthroughs-btn.executing {
    background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%) !important;
    transform: none !important;
    box-shadow: none !important;
}

.start-walkthroughs-btn.executing::after {
    content: ' (Executing...)';
    color: rgba(255, 255, 255, 0.8);
}

        /* ============================================== */
        /* BASE COMPONENTS */
        /* ============================================== */
        
        /* Base container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }
        
        /* Loading state */
        .loading-state {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            flex-direction: column;
            gap: 20px;
            background: #f5f7fa;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Header styling */
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            border-radius: 12px;
            color: white;
            box-shadow: 0 8px 25px rgba(30, 60, 114, 0.3);
        }
        
        .header h1 {
            margin: 0 0 10px 0;
            font-size: 2.2rem;
            font-weight: 700;
        }
        
        .header p {
            margin: 0;
            font-size: 1rem;
            opacity: 0.9;
        }

        /* Main grid layout */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }

        /* ============================================== */
        /* TEST BED COMPONENTS */
        /* ============================================== */

        /* Test bed info styling with compact grid layout */
        .test-bed-info {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            padding: 20px;
            border-radius: 12px;
            border-left: 5px solid #2196f3;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.2);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .test-bed-info h3 {
            margin: 0;
            color: #1565c0;
            font-weight: 600;
            text-align: center;
            border-bottom: 2px solid rgba(21, 101, 192, 0.2);
            padding-bottom: 10px;
        }

        /* Compact grid layout for test bed sections */
        .test-bed-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .test-bed-section {
            background: rgba(255, 255, 255, 0.8);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(21, 101, 192, 0.1);
        }

        .test-bed-section h4 {
            margin: 0 0 8px 0;
            font-size: 0.9rem;
            font-weight: 600;
            color: #1565c0;
            border-bottom: 1px solid rgba(21, 101, 192, 0.2);
            padding-bottom: 4px;
        }

        .test-bed-items {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 6px;
            font-size: 0.8rem;
        }

        .test-bed-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 3px 6px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 4px;
            border-left: 2px solid #2196f3;
        }

        .test-bed-label {
            font-weight: 600;
            color: #1565c0;
            font-size: 0.75rem;
        }

        .test-bed-value {
            color: #2c3e50;
            font-weight: 500;
            text-align: right;
            font-size: 0.75rem;
        }

        /* ============================================== */
        /* STATUS AND LOGGING */
        /* ============================================== */

        /* Better status log layout */
        .status {
            background: #f8f9fc;
            padding: 15px;
            border-radius: 12px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e1e5e9;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            white-space: pre-line;
            line-height: 1.4;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        /* Log entry styling */
        .log-entry {
            margin: 2px 0;
            padding: 2px 0;
        }
        
        .log-timestamp {
            color: #666;
            font-size: 10px;
        }

        /* ============================================== */
        /* FORM COMPONENTS */
        /* ============================================== */

        /* Test selection styling */
        .test-selection {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            padding: 20px;
            border-radius: 12px;
            border-left: 5px solid #ffc107;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.2);
        }
        
        .test-selection h4 {
            margin: 0 0 15px 0;
            color: #856404;
            font-weight: 600;
        }
        
        .test-checkboxes {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 10px;
        }
        
        .test-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            border-radius: 6px;
            transition: background 0.2s ease;
            cursor: pointer;
        }
        
        .test-checkbox:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        /* Tier selection styling */
        .tier-selection {
            background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c8 100%);
            padding: 20px;
            border-radius: 12px;
            border-left: 5px solid #4caf50;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.2);
        }
        
        .tier-selection h4 {
            margin: 0 0 15px 0;
            color: #2e7d32;
            font-weight: 600;
        }
        
        .tier-checkboxes {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .tier-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .tier-checkbox:hover {
            background: rgba(255, 255, 255, 0.9);
            transform: translateY(-2px);
        }

        /* ============================================== */
        /* WALKTHROUGH COMPONENTS */
        /* ============================================== */

        /* Domain walkthrough section styling */
        .walkthrough-section {
            background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
            padding: 20px;
            border-radius: 12px;
            border-left: 5px solid #9c27b0;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(156, 39, 176, 0.2);
        }
        
        .walkthrough-section h4 {
            margin: 0 0 15px 0;
            color: #7b1fa2;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .walkthrough-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 15px;
        }

        .walkthrough-selection, .tier-selection-walkthroughs {
            flex: 1;
            min-width: 250px;
        }

        .walkthrough-selection h5, .tier-selection-walkthroughs h5 {
            margin: 0 0 10px 0;
            color: #7b1fa2;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .walkthrough-checkboxes {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
        }

        .walkthrough-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 6px;
            transition: background 0.2s ease;
            cursor: pointer;
        }

        .walkthrough-checkbox:hover {
            background: rgba(255, 255, 255, 0.9);
        }

        .walkthrough-checkbox input:checked + span {
            background: rgba(156, 39, 176, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .walkthrough-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }

        /* Walkthrough button styles */
        .start-walkthroughs-btn {
            background: linear-gradient(135deg, #9c27b0 0%, #673ab7 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(156, 39, 176, 0.4);
        }

        .start-walkthroughs-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(156, 39, 176, 0.6);
        }

        .pause-walkthroughs-btn, .stop-walkthroughs-btn {
            padding: 10px 18px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pause-walkthroughs-btn {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
        }

        .stop-walkthroughs-btn {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
        }

        /* Tab system for walkthrough results */
        .walkthrough-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
            background: #f8f9fa;
            border-radius: 8px 8px 0 0;
            overflow: hidden;
        }

        .walkthrough-tab-button {
            padding: 12px 20px;
            border: none;
            background: none;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            color: #6c757d;
            flex: 1;
            text-align: center;
            outline: none;
            position: relative;
        }

        .walkthrough-tab-button:hover:not(.active) {
            background: rgba(156, 39, 176, 0.1);
            color: #9c27b0;
        }

        .walkthrough-tab-button.active {
            border-bottom-color: #9c27b0;
            font-weight: 600;
            color: #9c27b0;
            background: rgba(156, 39, 176, 0.05);
        }

        .walkthrough-tab-content {
            display: none !important;
            min-height: 200px;
            max-height: 60vh;
            overflow-y: auto;
            padding: 20px;
            border: 1px solid #e9ecef;
            border-top: none;
            background: white;
        }

        .walkthrough-tab-content.active {
            display: block !important;
        }

        /* ============================================== */
        /* RESULTS COMPONENTS */
        /* ============================================== */

        /* Walkthrough results section */
        .walkthrough-results-section {
            background: #f8f9fc;
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            border: 1px solid #e1e5e9;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }

        .walkthrough-results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e1e5e9;
        }

        .walkthrough-results-title {
            color: #2c3e50;
            font-size: 1.3rem;
            font-weight: 600;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Progress container for walkthroughs */
        .walkthrough-progress-container {
            background: linear-gradient(135deg, #9c27b0 0%, #673ab7 100%);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            color: white;
        }

        .walkthrough-progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .walkthrough-progress-bar-container {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            overflow: hidden;
            height: 10px;
            margin: 10px 0;
        }

        .walkthrough-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #4caf50 0%, #66bb6a 100%);
            transition: width 0.3s ease;
            border-radius: 8px;
            width: 0%;
        }

        .current-walkthrough-task {
            font-size: 0.9rem;
            margin: 5px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .current-execution-info {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .domain-badge, .tier-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
        }

        /* Domain summary styling */
        .domain-summary {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: white;
        }

        .domain-summary h5 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 1.1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tier-results-walkthrough {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .tier-result-walkthrough {
            flex: 1;
            min-width: 200px;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #e1e5e9;
        }

        .tier-result-walkthrough.Q1 { 
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); 
            border-left: 4px solid #ff9800;
        }
        .tier-result-walkthrough.Q4 { 
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); 
            border-left: 4px solid #2196f3;
        }
        .tier-result-walkthrough.Q8 { 
            background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c8 100%); 
            border-left: 4px solid #4caf50;
        }

        .tier-result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .tier-result-header h6 {
            margin: 0;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .walkthrough-metrics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            font-size: 0.8rem;
        }

        .walkthrough-metric {
            display: flex;
            justify-content: space-between;
            padding: 3px 6px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 3px;
        }

        .walkthrough-metric-label {
            font-weight: 500;
            color: #666;
        }

        .walkthrough-metric-value {
            font-weight: 600;
            color: #2c3e50;
        }

        .walkthrough-recommendations {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }

        .walkthrough-recommendations h6 {
            margin: 0 0 5px 0;
            font-size: 0.8rem;
            color: #666;
        }

        .walkthrough-recommendations ul {
            margin: 0;
            padding-left: 15px;
            font-size: 0.75rem;
            color: #555;
        }

        /* Export section for walkthroughs */
        .walkthrough-export-section {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #e1e5e9;
        }

        .walkthrough-export-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #28a745;
            color: white;
        }

        .walkthrough-export-btn:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        /* Walkthrough error styling */
        .walkthrough-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 6px;
            padding: 10px;
            margin: 10px 0;
            color: #721c24;
        }

        .walkthrough-error .error-content {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 10px;
        }

        .walkthrough-error .error-close {
            background: none;
            border: none;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            color: #721c24;
        }

        /* Additional Walkthrough Results Styling */
        .walkthrough-results-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid #e1e5e9;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .container-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e1e5e9;
        }

        .container-header h4 {
            margin: 0;
            color: #2c3e50;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .filter-controls {
            display: flex;
            gap: 10px;
        }

        .filter-controls select {
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            font-size: 0.9rem;
        }

        .results-list {
            min-height: 200px;
            max-height: 60vh;
            overflow-y: auto;
        }

        /* Individual Walkthrough Result Cards */
        .walkthrough-result {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 10px 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border-left: 5px solid #3498db;
            transition: all 0.3s ease;
            animation: fadeIn 0.5s ease-in;
        }

        .walkthrough-result:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .walkthrough-result.success {
            border-left-color: #27ae60;
            background: linear-gradient(135deg, #f8fff8 0%, #f0fff0 100%);
        }

        .walkthrough-result.partial {
            border-left-color: #f39c12;
            background: linear-gradient(135deg, #fffaf0 0%, #fff8e1 100%);
        }

        .walkthrough-result.failed {
            border-left-color: #e74c3c;
            background: linear-gradient(135deg, #fff5f5 0%, #ffeaea 100%);
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .result-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .result-title h4 {
            margin: 0;
            color: #2c3e50;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .domain-icon {
            font-size: 1.2rem;
        }

        .tier-badge.tier-q1 { background: #e65100; }
        .tier-badge.tier-q4 { background: #1976d2; }
        .tier-badge.tier-q8 { background: #388e3c; }

        .result-timestamp {
            font-size: 0.8rem;
            color: #666;
            font-style: italic;
        }

        .result-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.03);
            border-radius: 6px;
        }

        .metric-label {
            font-size: 0.85rem;
            color: #666;
            font-weight: 500;
        }

        .metric-value {
            font-size: 0.9rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .result-summary {
            background: rgba(0, 0, 0, 0.02);
            padding: 10px;
            border-radius: 6px;
            margin: 15px 0;
        }

        .result-summary p {
            margin: 5px 0;
            font-size: 0.9rem;
        }

        .result-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }

        .view-details-btn, .export-single-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .view-details-btn {
            background: #3498db;
            color: white;
        }

        .view-details-btn:hover {
            background: #2980b9;
        }

        .export-single-btn {
            background: #95a5a6;
            color: white;
        }

        .export-single-btn:hover {
            background: #7f8c8d;
        }

        /* Summary Dashboard Styling */
        .summary-dashboard {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            padding: 20px;
            color: white;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            color: #2c3e50;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #2c3e50;
        }

        /* No results state */
        .no-results {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
            font-style: italic;
        }

        /* ============================================== */
        /* CONTROLS AND BUTTONS */
        /* ============================================== */

        /* Controls styling */
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 25px 0;
            padding: 20px;
            background: #f8f9fc;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .control-group h5 {
            margin: 0;
            color: #2c3e50;
            font-size: 0.9rem;
            font-weight: 600;
        }

        /* Button styling */
        button {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        
        .btn-stop {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            color: #d63031;
        }
        
        .btn-pause {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        
        .btn-resume {
            background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
            color: white;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: #5a6268;
            transform: translateY(-1px);
        }
        
        button:disabled {
            background: #e9ecef;
            color: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* ============================================== */
        /* PROGRESS AND STATUS */
        /* ============================================== */

        /* Progress section styling */
        .progress-section {
            margin: 25px 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            color: white;
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .progress-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin: 0;
        }
        
        .progress-bar-container {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
            height: 12px;
            margin: 10px 0;
        }
        
        #progressBar {
            height: 100%;
            background: linear-gradient(90deg, #4ecdc4 0%, #44a08d 100%);
            transition: width 0.3s ease;
            border-radius: 10px;
            width: 0%;
        }

        .progress-text {
            font-size: 0.9rem;
            margin: 5px 0;
            font-weight: 500;
        }
        
        .time-estimate {
            font-size: 0.85rem;
            opacity: 0.9;
            font-style: italic;
        }

        /* Status indicators */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-idle { 
            background: rgba(108, 117, 125, 0.3);
            color: #f8f9fa;
        }
        .status-running { 
            background: rgba(40, 167, 69, 0.3);
            color: #d4edda;
            animation: pulse 2s infinite;
        }
        .status-paused { 
            background: rgba(255, 193, 7, 0.3);
            color: #fff3cd;
        }
        .status-stopped { 
            background: rgba(220, 53, 69, 0.3);
            color: #f8d7da;
        }
        .status-completed { 
            background: rgba(40, 167, 69, 0.3);
            color: #d4edda;
        }

        /* Auto-scroll toggle styling */
        .auto-scroll-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin: 20px 0;
            font-weight: 500;
        }

        /* Results styling */
        .results {
            margin-top: 25px;
        }
        
        .results h3 {
            font-size: 1.4rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .results-panel {
            background: #f8f9fc;
            border-radius: 12px;
            padding: 20px;
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #e1e5e9;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }

        /* Summary grid styling */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        /* Empty state styling */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
            font-size: 1rem;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 8px;
            border: 2px dashed #dee2e6;
        }

        .empty-state small {
            display: block;
            margin-top: 10px;
            opacity: 0.8;
            font-style: italic;
        }

        /* ============================================== */
        /* APPENDIX-STYLE COMPONENTS */
        /* ============================================== */
        
        /* Detailed Results Container */
        .detailed-results-container {
            background: #f8f9fc;
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            border: 1px solid #e1e5e9;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            display: none;
        }
        
        .detailed-results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e1e5e9;
        }
        
        .detailed-results-title {
            color: #2c3e50;
            font-size: 1.3rem;
            font-weight: 600;
            margin: 0;
        }
        
        .detailed-controls {
            display: flex;
            gap: 10px;
        }
        
        .toggle-detailed-btn, .export-detailed-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .toggle-detailed-btn {
            background: #6c757d;
            color: white;
        }
        
        .toggle-detailed-btn:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }
        
        .export-detailed-btn {
            background: #28a745;
            color: white;
        }
        
        .export-detailed-btn:hover {
            background: #218838;
            transform: translateY(-1px);
        }
        
        .detailed-content {
            background: white;
            border-radius: 8px;
            padding: 20px;
            min-height: 200px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        /* Live Comparison Container */
        .live-comparison-container {
            background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c8 100%);
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            border-left: 5px solid #28a745;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.2);
            display: none;
        }
        
        .live-comparison-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .live-comparison-title {
            color: #2e7d32;
            font-size: 1.3rem;
            font-weight: 600;
            margin: 0;
        }
        
        .live-progress-indicator {
            display: flex;
            gap: 15px;
            align-items: center;
            font-size: 0.9rem;
            color: #2e7d32;
        }
        
        .current-test, .current-tier, .test-status {
            background: rgba(255, 255, 255, 0.7);
            padding: 4px 8px;
            border-radius: 15px;
            font-weight: 600;
            font-size: 0.8rem;
        }
        
        .live-comparison-content {
            background: white;
            border-radius: 8px;
            padding: 20px;
            min-height: 150px;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        /* Table styling for live comparison and detailed content */
        .live-comparison-content table,
        .detailed-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 10px 0;
            font-size: 0.85rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .live-comparison-content table th,
        .live-comparison-content table td,
        .detailed-content table th,
        .detailed-content table td {
            border: 1px solid #e1e5e9;
            padding: 8px 12px;
            text-align: left;
        }
        
        .live-comparison-content table th,
        .detailed-content table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            text-align: center;
        }
        
        .live-comparison-content table tbody tr:nth-child(even),
        .detailed-content table tbody tr:nth-child(even) {
            background: #f8f9fc;
        }
        
        .live-comparison-content table tbody tr:hover,
        .detailed-content table tbody tr:hover {
            background: #e3f2fd;
            transition: background 0.2s ease;
        }
        
        /* Tier comparison grid */
        .tier-comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }
        
        .tier-column {
            background: white;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #e1e5e9;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .tier-header {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 10px;
            text-align: center;
            padding: 8px;
            border-radius: 6px;
            color: white;
        }
        
        .tier-header.tier-Q1 { background: #e65100; }
        .tier-header.tier-Q4 { background: #1976d2; }
        .tier-header.tier-Q8 { background: #388e3c; }
        
        .tier-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .metric-item {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            padding: 4px 8px;
            background: #f8f9fc;
            border-radius: 4px;
        }
        
        .recent-tests {
            border-top: 1px solid #e1e5e9;
            padding-top: 10px;
        }
        
        .recent-test {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 8px;
            margin: 4px 0;
            background: #f8f9fc;
            border-radius: 4px;
            font-size: 0.8rem;
        }
        
        .recent-test.mcd-aligned {
            border-left: 3px solid #28a745;
        }
        
        .test-id {
            font-weight: 600;
            color: #2c3e50;
        }
        
        /* Status badge styling */
        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-align: center;
        }
        
        .status-badge.success { background: #d4edda; color: #155724; }
        .status-badge.warning { background: #fff3cd; color: #856404; }
        .status-badge.danger { background: #f8d7da; color: #721c24; }
        .status-badge.info { background: #d1ecf1; color: #0c5460; }
        
        /* Pulse animation for live updates */
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        /* Fade-in animations for new components */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        /* Scrollbar styling for content areas */
        .detailed-content::-webkit-scrollbar,
        .live-comparison-content::-webkit-scrollbar,
        .walkthrough-tab-content::-webkit-scrollbar {
            width: 8px;
        }
        
        .detailed-content::-webkit-scrollbar-track,
        .live-comparison-content::-webkit-scrollbar-track,
        .walkthrough-tab-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .detailed-content::-webkit-scrollbar-thumb,
        .live-comparison-content::-webkit-scrollbar-thumb,
        .walkthrough-tab-content::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        .detailed-content::-webkit-scrollbar-thumb:hover,
        .live-comparison-content::-webkit-scrollbar-thumb:hover,
        .walkthrough-tab-content::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Hide modular components initially */
        #detailedResultsContainer,
        #liveComparisonContainer {
            display: none;
        }

        /* ============================================== */
        /* UNIFIED FRAMEWORK STYLES */
        /* ============================================== */

        .unified-execution-section {
            position: relative;
            overflow: hidden;
        }

        .unified-execution-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s;
        }

        .unified-execution-section:hover::before {
            left: 100%;
        }

        .framework-status {
            transition: all 0.3s ease;
        }

        .framework-status:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .cross-framework-section {
            animation: slideInFromBottom 0.6s ease-out;
        }

        .correlation-card {
            transition: all 0.3s ease;
        }

        .correlation-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
        }

        /* ============================================== */
        /* RESPONSIVE DESIGN */
        /* ============================================== */
        
        /* Tablet adjustments */
        @media (max-width: 1024px) {
            .test-bed-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .test-bed-items {
                grid-template-columns: 1fr;
            }

            .walkthrough-controls {
                flex-direction: column;
            }
        }

        /* Mobile adjustments */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .controls {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
            
            .test-checkboxes {
                grid-template-columns: 1fr;
            }
            
            .tier-checkboxes {
                flex-direction: column;
                align-items: center;
            }
            
            .detailed-controls {
                flex-direction: column;
                gap: 8px;
            }
            
            .live-progress-indicator {
                flex-direction: column;
                gap: 8px;
            }
            
            .tier-comparison-grid {
                grid-template-columns: 1fr;
            }
            
            .detailed-results-container {
                padding: 15px;
                margin: 15px 0;
            }
            
            .live-comparison-container {
                padding: 15px;
                margin: 15px 0;
            }
            
            .detailed-content,
            .live-comparison-content {
                max-height: 60vh;
            }
            
            .detailed-content table,
            .live-comparison-content table {
                font-size: 0.8rem;
            }
            
            .detailed-content table th,
            .detailed-content table td,
            .live-comparison-content table th,
            .live-comparison-content table td {
                padding: 6px 4px;
            }
            
            .tier-metrics {
                grid-template-columns: 1fr;
            }

            .test-bed-grid {
                grid-template-columns: 1fr;
            }

            .walkthrough-actions {
                flex-direction: column;
                align-items: center;
            }

            .tier-results-walkthrough {
                flex-direction: column;
            }

            .walkthrough-export-section {
                flex-wrap: wrap;
                gap: 8px;
            }

            .unified-execution-section {
                padding: 15px;
            }
            
            .unified-execution-section div[style*="display: flex"] {
                flex-direction: column;
                gap: 10px;
            }
            
            .correlation-grid {
                grid-template-columns: 1fr !important;
            }

            .walkthrough-tabs {
                flex-direction: column;
            }
            
            .walkthrough-tab-button {
                border-bottom: 1px solid #e9ecef;
                border-right: none;
                text-align: left;
            }
            
            .walkthrough-tab-button.active {
                border-left: 4px solid #9c27b0;
                border-bottom: 1px solid #e9ecef;
            }
        }
        
        /* Print styles */
        @media print {
            .detailed-controls,
            .live-progress-indicator {
                display: none;
            }
            
            .detailed-results-container,
            .live-comparison-container,
            .walkthrough-results-section {
                box-shadow: none;
                border: 1px solid #333;
                page-break-inside: avoid;
            }
            
            .detailed-content table,
            .live-comparison-content table {
                page-break-inside: auto;
            }
            
            .detailed-content table tr,
            .live-comparison-content table tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }
			
			/* ✅ CRITICAL: WalkthroughUI Tab Integration Fix */
.walkthrough-tab-content {
    display: none !important;
    padding: 20px;
    border: 1px solid #e9ecef;
    border-top: none;
    background: white;
    min-height: 300px;
}

.walkthrough-tab-content.active {
    display: block !important;
}

/* ✅ Tab Button Active State */
.walkthrough-tab-button.active {
    background: rgba(156, 39, 176, 0.1);
    border-bottom: 3px solid #9c27b0;
    color: #9c27b0;
    font-weight: 600;
}

/* ✅ Force Visibility Override */
#walkthrough-summary,
#walkthrough-detailed, 
#walkthrough-comparison {
    visibility: visible !important;
    opacity: 1 !important;
}
/* Always show detailed results - no hiding */
#detailedResultsContainer {
    display: block !important;
    background: #f8f9fc;
    border-radius: 12px;
    padding: 25px;
    margin: 20px 0;
    border: 1px solid #e1e5e9;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
}


        }
    </style>

</head>
<body>
    <!-- Loading State -->
    <div id="loadingState" class="loading-state">
        <div class="spinner"></div>
        <h2>🧪 Loading MCD Simulation Runner</h2>
        <p>Initializing comprehensive test framework...</p>
    </div>

    <!-- Main Application Container -->
    <div id="mainApp" class="container" style="display: none;">
        
        <!-- Header -->
        <div class="header">
            <h1>🧪 MCD Simulation Runner</h1>
            <p>Browser-Based T1-T10 Validation Framework with Appendix-Style Analysis</p>
            <!-- Enhanced Status Integration -->
<div style="margin-top: 15px; display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
    <span class="status-indicator status-idle" id="headerStatusIndicator">Ready</span>
    <span id="statusText">Comprehensive T1-T10 + Chapter 7 framework ready</span>
    
    <!-- ADD: Framework Status Indicators -->
    <div style="display: flex; gap: 10px; margin-left: auto;">
        <span class="framework-status" id="t1t10Status" style="background: rgba(102, 126, 234, 0.8); color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: 600;">
            📊 T1-T10: Ready
        </span>
        <span class="framework-status" id="chapter7Status" style="background: rgba(156, 39, 176, 0.8); color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: 600;">
            🎯 Chapter 7: Ready
        </span>
    </div>
</div>

        </div>

        <!-- Main Grid - Test Bed Info & Status Log -->
        <div class="main-grid">
            <div class="test-bed-info" id="testBedInfo">
                <h3>🔬 Test Bed Configuration</h3>
                <div class="test-bed-grid">
                    <div class="test-bed-section">
                        <h4>🌐 Environment</h4>
                        <div class="test-bed-items">
                            <div class="test-bed-item">
                                <span class="test-bed-label">Browser:</span>
                                <span class="test-bed-value">Chrome Edg/138.0.0.0</span>
                            </div>
                            <div class="test-bed-item">
                                <span class="test-bed-label">WebGPU:</span>
                                <span class="test-bed-value">Supported ✅</span>
                            </div>
                            <div class="test-bed-item">
                                <span class="test-bed-label">GPU:</span>
                                <span class="test-bed-value">Available ⚠️</span>
                            </div>
                            <div class="test-bed-item">
                                <span class="test-bed-label">Memory:</span>
                                <span class="test-bed-value">8GB</span>
                            </div>
                            <div class="test-bed-item">
                                <span class="test-bed-label">Platform:</span>
                                <span class="test-bed-value">Win32</span>
                            </div>
                            <div class="test-bed-item">
                                <span class="test-bed-label">CPU Cores:</span>
                                <span class="test-bed-value">8</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="test-bed-section">
                        <h4>🤖 Available Models</h4>
                        <div class="test-bed-items">
                            <div class="test-bed-item">
                                <span class="test-bed-label">Total:</span>
                                <span class="test-bed-value">141</span>
                            </div>
                            <div class="test-bed-item">
                                <span class="test-bed-label">TinyLlama:</span>
                                <span class="test-bed-value">8</span>
                            </div>
                            <div class="test-bed-item">
                                <span class="test-bed-label">Phi:</span>
                                <span class="test-bed-value">18</span>
                            </div>
                            <div class="test-bed-item">
                                <span class="test-bed-label">Gemma:</span>
                                <span class="test-bed-value">12</span>
                            </div>
                            <div class="test-bed-item">
                                <span class="test-bed-label">Llama:</span>
                                <span class="test-bed-value">39</span>
                            </div>
                            <div class="test-bed-item">
                                <span class="test-bed-label">Qwen:</span>
                                <span class="test-bed-value">45</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="test-bed-section">
                        <h4>🎯 Selected Models</h4>
                        <div class="test-bed-items">
                            <div class="test-bed-item">
                                <span class="test-bed-label">Q1 Tier:</span>
                                <span class="test-bed-value">Qwen2-0.5B...</span>
                            </div>
                            <div class="test-bed-item">
                                <span class="test-bed-label">Q4 Tier:</span>
                                <span class="test-bed-value">Not selected</span>
                            </div>
                            <div class="test-bed-item">
                                <span class="test-bed-label">Q8 Tier:</span>
                                <span class="test-bed-value">Not selected</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="test-bed-section">
                        <h4>📊 Performance Metrics</h4>
                        <div class="test-bed-items">
                            <div class="test-bed-item">
                                <span class="test-bed-label">Tests Run:</span>
                                <span class="test-bed-value">0</span>
                            </div>
                            <div class="test-bed-item">
                                <span class="test-bed-label">Avg Time:</span>
                                <span class="test-bed-value">0ms</span>
                            </div>
                            <div class="test-bed-item">
                                <span class="test-bed-label">Status:</span>
                                <span class="test-bed-value">✅ Ready</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="status" id="statusLog">📋 MCD Validation System Ready...

🔧 System Components:
✅ UI Components: Comprehensive interface loaded
✅ Test Engine: Appendix-style runners ready  
✅ State Management: Enhanced controls active
✅ Data Export: Professional exporters ready
✅ Live Displays: Real-time tracking initialized
✅ Tier Comparison: Advanced analysis system ready

🎯 Key Features:
• Live appendix-style test execution tracking
• Multi-trial detailed analysis with comprehensive tables
• Real-time tier comparison with performance metrics
• Advanced efficiency scoring and MCD verdicts
• Browser compatibility checks and optimization
• Professional data visualization and reporting
• Modular architecture with enhanced components

System ready for comprehensive MCD testing...
            </div>
        </div>

        <!-- Test Selection -->
        <div class="test-selection">
            <h4>🎯 Test Selection - T1-T10 Framework</h4>
            <div class="test-checkboxes">
                <label class="test-checkbox">
                    <input type="checkbox" checked onclick="toggleTest('T1')">
                    <span>T1: Minimal vs Verbose Prompting</span>
                </label>
                <label class="test-checkbox">
                    <input type="checkbox" checked onclick="toggleTest('T2')">
                    <span>T2: Clinical Decision Support</span>
                </label>
                <label class="test-checkbox">
                    <input type="checkbox" checked onclick="toggleTest('T3')">
                    <span>T3: Ambiguous Input Recovery</span>
                </label>
                <label class="test-checkbox">
                    <input type="checkbox" checked onclick="toggleTest('T4')">
                    <span>T4: Multi-turn Context Preservation</span>
                </label>
                <label class="test-checkbox">
                    <input type="checkbox" checked onclick="toggleTest('T5')">
                    <span>T5: Spatial Navigation</span>
                </label>
                <label class="test-checkbox">
                    <input type="checkbox" checked onclick="toggleTest('T6')">
                    <span>T6: Over Engineering Detection</span>
                </label>
                <label class="test-checkbox">
                    <input type="checkbox" checked onclick="toggleTest('T7')">
                    <span>T7: Bounded Adaptation Failure</span>
                </label>
                <label class="test-checkbox">
                    <input type="checkbox" checked onclick="toggleTest('T8')">
                    <span>T8: Offline Execution Performance</span>
                </label>
                <label class="test-checkbox">
                    <input type="checkbox" checked onclick="toggleTest('T9')">
                    <span>T9: Recovery Chain Logic</span>
                </label>
                <label class="test-checkbox">
                    <input type="checkbox" checked onclick="toggleTest('T10')">
                    <span>T10: Model Tiering & Fallback Logic</span>
                </label>
            </div>
        </div>

        <!-- Tier Selection -->
        <div class="tier-selection">
            <h4>🏗️ Quantization Tier Selection</h4>
            <div class="tier-checkboxes">
                <label class="tier-checkbox">
                    <input type="checkbox" id="tierQ1" checked onclick="toggleTier('Q1')">
                    <span style="color: #e65100; font-weight: bold;">Q1 - Ultra-lightweight (~300MB)</span>
                </label>
                <label class="tier-checkbox">
                    <input type="checkbox" id="tierQ4" checked onclick="toggleTier('Q4')">
                    <span style="color: #1976d2; font-weight: bold;">Q4 - Balanced Performance (~600MB)</span>
                </label>
                <label class="tier-checkbox">
                    <input type="checkbox" id="tierQ8" checked onclick="toggleTier('Q8')">
                    <span style="color: #388e3c; font-weight: bold;">Q8 - High Capability (~650MB)</span>
                </label>
            </div>
            <p style="font-size: 12px; color: #666; margin: 10px 0 0 0; text-align: center; font-style: italic;">
                Select quantization tiers for comprehensive MCD validation with live comparison
            </p>
        </div>

 <!-- Controls -->
        <div class="controls">
            <div class="control-group">
                <h5>🎮 Test Execution</h5>
                <button id="startTests" onclick="startTests()" class="btn-primary">🚀 Start Tests</button>
                <button id="stopTests" onclick="stopTests()" disabled class="btn-stop">🛑 Stop</button>
                <button id="pauseTests" onclick="pauseTests()" disabled class="btn-pause">⏸️ Pause</button>
                <button id="resumeTests" onclick="resumeTests()" disabled class="btn-resume" style="display: none;">▶️ Resume</button>
            </div>
            <div class="control-group">
                <h5>🗑️ Data Management</h5>
                <button id="clearResults" onclick="clearResults()" class="btn-secondary">🗑️ Clear Results</button>
                <button id="clearLogs" onclick="clearLogs()" class="btn-secondary">📝 Clear Logs</button>
            </div>
            <div class="control-group">
                <h5>📥 Export Options</h5>
                <button id="downloadResults" onclick="downloadResults()" disabled class="btn-secondary">📥 Download JSON</button>
                <button id="downloadCSV" onclick="downloadCSV()" disabled class="btn-secondary">📊 Download CSV</button>
            </div>
            <div class="control-group">
                <h5>🎛️ View Controls</h5>
                <button onclick="scrollToDetailedResults()" class="btn-secondary">📄 Jump to Details</button>
                <button onclick="exportDetailedResults()" disabled class="btn-secondary">📋 Export Report</button>
            </div>
        </div>

        <!-- Progress Section -->
    

        <!-- Auto-scroll Toggle -->
        <!-- Auto-scroll Toggle -->
<div class="auto-scroll-toggle">
    <input type="checkbox" id="autoScroll" checked>
    <label for="autoScroll">Auto-scroll to latest T1-T10 results</label>
    <input type="checkbox" id="autoScrollWalkthroughs" checked>
    <label for="autoScrollWalkthroughs">Auto-scroll to latest walkthrough results</label>
</div>
 


        <!-- ============================================== -->
        <!-- 📋 NEW: CHAPTER 7 DOMAIN WALKTHROUGHS SECTION -->
        <!-- ============================================== -->
        
        <div class="walkthrough-section">
            <h4>📋 Chapter 7: Domain Walkthroughs</h4>
            <div class="walkthrough-controls">
                
                <div class="walkthrough-selection">
                    <h5>Select Domain Walkthroughs:</h5>
                    <div class="walkthrough-checkboxes">
                        <label class="walkthrough-checkbox">
                            <input type="checkbox" id="D1-checkbox" checked>
                            <span>📅 D1: Appointment Booking Agent</span>
                        </label>
                        <label class="walkthrough-checkbox">
                            <input type="checkbox" id="D2-checkbox" checked>
                            <span>🧭 D2: Spatial Navigation Agent</span>
                        </label>
                        <label class="walkthrough-checkbox">
                            <input type="checkbox" id="D3-checkbox" checked>
                            <span>🔧 D3: Failure Diagnostics Agent</span>
                        </label>
                    </div>
                </div>
                
                <div class="tier-selection-walkthroughs">
                    <h5>Quantization Tiers:</h5>
                    <div class="walkthrough-checkboxes">
                        <label class="walkthrough-checkbox">
                            <input type="checkbox" id="Q1-walkthrough-checkbox" checked>
                            <span style="color: #e65100; font-weight: bold;">Q1 (Ultra-lightweight)</span>
                        </label>
                        <label class="walkthrough-checkbox">
                            <input type="checkbox" id="Q4-walkthrough-checkbox" checked>
                            <span style="color: #1976d2; font-weight: bold;">Q4 (Balanced)</span>
                        </label>
                        <label class="walkthrough-checkbox">
                            <input type="checkbox" id="Q8-walkthrough-checkbox" checked>
                            <span style="color: #388e3c; font-weight: bold;">Q8 (High-capability)</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="walkthrough-actions">
                <button 
  id="start-walkthroughs-btn" 
  onclick="safeStartWalkthroughs()"
  class="start-walkthroughs-btn">
  🚀 Start Domain Walkthroughs
</button>
                <button id="pause-walkthroughs-btn" class="pause-walkthroughs-btn" style="display:none;">⏸️ Pause</button>
                <button id="stop-walkthroughs-btn" class="stop-walkthroughs-btn" style="display:none;">⏹️ Stop</button>
            </div>
        </div>

       


        <!-- Test Summary -->
        <div id="testSummary" class="summary-grid"></div>

<!-- Unified Framework Execution Control -->
 
<div id="liveComparisonContainer" class="live-comparison-container" style="display: none;">
            <!-- Populated by LiveComparison module with appendix-style displays -->
        </div>

        <!-- Detailed Results Container -->
        <div id="detailedResultsContainer" class="detailed-results-container" style="display: none;">
            <!-- Populated by DetailedResults module with comprehensive analysis -->
	
		</div>


        <!-- ============================================== -->
        <!-- 📋 NEW: DOMAIN WALKTHROUGH RESULTS SECTION -->
        <!-- ============================================== -->
        
        <div class="walkthrough-results-section" id="walkthrough-results-section">

            <div class="walkthrough-results-header">
                <h3 class="walkthrough-results-title">📊 Domain Walkthrough Results</h3>
            </div>
			
 


            <div id="walkthrough-progress" class="walkthrough-progress-container" style="display:none;">
                <!-- Populated by walkthrough UI module -->
            </div>
            
<div class="walkthrough-tabs">
    <button class="walkthrough-tab-button active" onclick="if(window.walkthroughUI) window.walkthroughUI.showTab('summary')">📈 Summary</button>
    <button class="walkthrough-tab-button" onclick="if(window.walkthroughUI) window.walkthroughUI.showTab('detailed')">🔍 Detailed Analysis</button>
    <button class="walkthrough-tab-button" onclick="if(window.walkthroughUI) window.walkthroughUI.showTab('comparison')">⚖️ Tier Comparison</button>
</div>



            
            <div id="walkthrough-summary" class="walkthrough-tab-content active">
    <div class="empty-state">
        🧪 Domain walkthrough results will appear here after execution
        <br><small style="margin-top: 10px; display: block; opacity: 0.8;">
            Start domain walkthroughs to see comprehensive analysis
        </small>
    </div>
</div>

<div id="walkthrough-detailed" class="walkthrough-tab-content">
    <div class="empty-state">
        📝 Detailed scenario-by-scenario analysis will appear here
    </div>
</div>

<div id="walkthrough-comparison" class="walkthrough-tab-content">
    <div class="empty-state">
        ⚖️ Tier comparison analysis will appear here
    </div>
</div>

          
<!-- ADD: Individual Walkthrough Results Container -->
<div id="walkthroughResultsContainer" class="walkthrough-results-container">
    <div class="container-header">
        <h4>Individual Walkthrough Results</h4>
        <div class="filter-controls">
            <select id="domainFilter">
                <option value="all">All Domains</option>
                <option value="D1">Appointment Booking</option>
                <option value="D2">Spatial Navigation</option>
                <option value="D3">Failure Diagnostics</option>
            </select>
            <select id="tierFilter">
                <option value="all">All Tiers</option>
                <option value="Q1">Q1 Tier</option>
                <option value="Q4">Q4 Tier</option>
                <option value="Q8">Q8 Tier</option>
            </select>
        </div>
    </div>
    <div id="walkthroughResults" class="results-list">
        <!-- Dynamic walkthrough results will be inserted here -->
        <div class="empty-state">
            🔬 Individual walkthrough results will appear here as tests complete
        </div>
    </div>
</div>




<div class="walkthrough-export-section">
    <button onclick="exportWalkthroughJSON()" class="walkthrough-export-btn">📁 Export JSON</button>
    <button onclick="exportWalkthroughCSV()" class="walkthrough-export-btn">📊 Export CSV</button>
    <button onclick="exportWalkthroughSummary()" class="walkthrough-export-btn">📋 Export Summary</button>
</div>


        <!-- Modular Component Containers -->
        
        <!-- Live Comparison Container (Above detailed results for better flow) -->
        

        <!-- Main Results Section -->
        <div class="results">
            <h3>📊 Test Results</h3>
            <div class="results-panel" id="resultsContainer">
                <div class="empty-state">
                    🧪 Test results will appear here after execution
                    <br><small style="margin-top: 10px; display: block; opacity: 0.8;">
                        Start tests to see live appendix-style analysis and tier comparisons
                    </small>
                </div>
            </div>
        </div>
    </div>

 <!-- Cross-Framework Results Correlation -->
  <div id="crossFrameworkCorrelation" class="cross-framework-section" style="background: linear-gradient(135deg, #fdcb6e 0%, #e17055 100%); border-radius: 12px; padding: 25px; margin: 20px 0; color: white; display: none;">
    <h3 style="margin: 0 0 15px 0;">🔗 Cross-Framework Analysis</h3>
    
    <div class="correlation-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
        <div class="correlation-card" style="background: rgba(255, 255, 255, 0.9); color: #2c3e50; padding: 15px; border-radius: 8px;">
            <h5 style="margin: 0 0 10px 0;">Consistency Score</h5>
            <div id="consistencyScore" style="font-size: 1.5rem; font-weight: bold;">--</div>
        </div>
        <div class="correlation-card" style="background: rgba(255, 255, 255, 0.9); color: #2c3e50; padding: 15px; border-radius: 8px;">
            <h5 style="margin: 0 0 10px 0;">Coverage Overlap</h5>
            <div id="coverageOverlap" style="font-size: 1.5rem; font-weight: bold;">--</div>
        </div>
        <div class="correlation-card" style="background: rgba(255, 255, 255, 0.9); color: #2c3e50; padding: 15px; border-radius: 8px;">
            <h5 style="margin: 0 0 10px 0;">MCD Alignment</h5>
            <div id="crossMcdAlignment" style="font-size: 1.5rem; font-weight: bold;">--</div>
        </div>
    </div>
    
    <div style="margin-top: 15px; text-align: center;">
        <button onclick="exportUnifiedAnalysis()" class="btn-secondary" style="background: rgba(255, 255, 255, 0.9); color: #2c3e50;">
            📋 Export Unified Report
        </button>
    </div>
</div>  

    
<!-- Load the modular browser-main.ts -->
<script type="module" src="./src/browser-main.ts"></script>

<!-- Initialize app visibility -->
<script>

// ENHANCED: Comprehensive Memory Management
class HTMLMemoryManager {
    constructor() {
        this.activeTimeouts = new Set();
        this.activeIntervals = new Set();
        this.eventListeners = new Map();
        this.originalSetTimeout = window.setTimeout;
        this.originalSetInterval = window.setInterval;
        
        this.setupTracking();
    }
    
    setupTracking() {
        // Track timeouts
        window.setTimeout = (fn, delay, ...args) => {
    const id = this.originalSetTimeout.call(window, () => {
        this.activeTimeouts.delete(id);
        if (typeof fn === 'function') {
            fn(...args);
        }
    }, delay);
    this.activeTimeouts.add(id);
    return id;
};

window.setInterval = (fn, delay, ...args) => {
    const id = this.originalSetInterval.call(window, () => {
        if (typeof fn === 'function') {
            fn(...args);
        }
    }, delay);
    this.activeIntervals.add(id);
    return id;
};

        
        console.log('✅ Memory tracking enabled');
    }
    
    cleanup() {
        try {
            // Clear all tracked timeouts
            this.activeTimeouts.forEach(id => clearTimeout(id));
            this.activeTimeouts.clear();
            
            // Clear all tracked intervals
            this.activeIntervals.forEach(id => clearInterval(id));
            this.activeIntervals.clear();
            
            // Remove event listeners
            this.eventListeners.forEach(({ element, event, handler }) => {
                element.removeEventListener(event, handler);
            });
            this.eventListeners.clear();
            
            console.log('✅ Memory cleanup completed');
        } catch (error) {
            console.error('Memory cleanup failed:', error);
        }
    }
    
    addEventListenerTracked(element, event, handler) {
        element.addEventListener(event, handler);
        this.eventListeners.set(`${element.id || 'unknown'}-${event}`, {
            element, event, handler
        });
    }
    
    getStats() {
        return {
            activeTimeouts: this.activeTimeouts.size,
            activeIntervals: this.activeIntervals.size,
            eventListeners: this.eventListeners.size
        };
    }
}
// MetaMask conflict prevention
(function() {
    'use strict';
    
    // Store original functions before any interference
    if (!window.originalSetTimeout) {
        window.originalSetTimeout = setTimeout;
        window.originalSetInterval = setInterval;
        window.originalClearTimeout = clearTimeout;
        window.originalClearInterval = clearInterval;
    }
    
    // Create safe wrapper functions
    window.safeSetTimeout = function(callback, delay) {
        if (typeof callback !== 'function') {
            console.warn('Invalid callback for setTimeout');
            return null;
        }
        return window.originalSetTimeout.call(window, callback, delay);
    };
    
    window.safeSetInterval = function(callback, delay) {
        if (typeof callback !== 'function') {
            console.warn('Invalid callback for setInterval');
            return null;
        }
        return window.originalSetInterval.call(window, callback, delay);
    };
    
    console.log('✅ MetaMask conflict prevention initialized');
})();

// Initialize memory manager
const memoryManager = new HTMLMemoryManager();

// Make it globally available
window.memoryManager = memoryManager;

// Auto-cleanup on page unload
window.addEventListener('beforeunload', () => memoryManager.cleanup());

document.addEventListener('DOMContentLoaded', async () => {
    try {
        // FIXED: Use proper JavaScript syntax instead of TypeScript
        if (window.immediateStop) return;
        
        // Memory-safe initialization with cleanup
// Enhanced memory-safe initialization with global scope
window.initializationTimeout = null;
window.emergencyTimeout = null;
window.emergencyCleanupTimeout = null;


// REPLACE the complex safeInitialization function with this simplified version:
const safeInitialization = async () => {
    try {
        if (window.immediateStop) return;
        
        // BYPASS: Skip all module checking - everything works anyway
        console.log('✅ Bypassing module checks - proceeding to show app');
        
        // Show app immediately after 1 second
        setTimeout(() => {
            try {
                const loading = document.getElementById('loadingState');
                const mainApp = document.getElementById('mainApp');
                
                if (loading) loading.style.display = 'none';
                if (mainApp) mainApp.style.display = 'block';
                
                console.log('✅ App shown via bypass method');
                initializeWalkthroughConnections();
                
            } catch (error) {
                console.error('Bypass method failed:', error);
                emergencyFallback();
            }
        }, 1000);
        
    } catch (error) {
        console.error('Bypass initialization failed:', error);
        emergencyFallback();
    }
};



// ADD this helper function BEFORE safeInitialization:
const waitForCriticalModules = async (modules, timeout = 5000) => {
    const startTime = Date.now();
    while (Date.now() - startTime < timeout) {
        const ready = modules.every(module => window[module]);
        if (ready) {
            console.log('✅ Critical modules ready:', modules.join(', '));
            return true;
        }
        await new Promise(resolve => setTimeout(resolve, 200));
    }
    console.warn('⚠️ Module timeout, missing:', 
        modules.filter(module => !window[module]));
    return false;
};

// ADD this connection initializer:
const initializeWalkthroughConnections = () => {
    try {
        // Enhanced safety checks
        const startBtn = document.getElementById('start-walkthroughs-btn');
        if (startBtn) {
            if (window.walkthroughUI && typeof window.walkthroughUI.startWalkthroughs === 'function') {
                startBtn.onclick = () => window.walkthroughUI.startWalkthroughs();
                console.log('✅ Walkthrough button connected');
            } else {
                // Fallback for when modules aren't ready
                startBtn.onclick = () => {
                    console.warn('⚠️ Walkthrough system not ready yet');
                    alert('Walkthrough system is still loading. Please try again in a moment.');
                };
            }
        }
        
        // Enhanced export function checks
        const exportButtons = ['json', 'csv'];
        exportButtons.forEach(format => {
            if (typeof window[`exportWalkthrough${format.toUpperCase()}`] === 'function') {
                console.log(`✅ Export ${format.toUpperCase()} function available`);
            }
        });
        
    } catch (error) {
        console.error('Connection initialization failed:', error);
    }
};




const emergencyFallback = () => {
    console.log('🚨 EMERGENCY FALLBACK: Force showing app');
    try {
        const loading = document.getElementById('loadingState');
        const mainApp = document.getElementById('mainApp');
        
        if (loading) loading.remove();
        if (mainApp) {
            mainApp.style.display = 'block';
            console.log('🚨 Emergency fallback: App forced visible');
        }
    } catch (fallbackError) {
        console.error('Emergency fallback failed:', fallbackError);
    }
};

// Execute safe initialization
safeInitialization();

    } catch (error) {
        console.error('❌ DOM initialization failed:', error);
        // EMERGENCY FALLBACK - force show app
        (window.safeSetTimeout || setTimeout)(() => {
            document.getElementById('loadingState')?.remove();
            const mainApp = document.getElementById('mainApp');
            if (mainApp) {
                mainApp.style.display = 'block';
                console.log('🚨 Emergency fallback: App forced visible');
            }
        }, 2000);
    }
});

 
// ✅ FIXED: Simplified and robust tab switching
// ✅ FIXED: Simplified and robust tab switching
async function showWalkthroughTab(tabName) {
    try {
        if (window.immediateStop || !tabName) {
            console.log('Tab switching blocked or invalid tab name');
            return;
        }
        
        console.log(`🔄 Switching to walkthrough tab: ${tabName}`);
        
        // 1. Hide ALL tab contents first
        const allTabContents = document.querySelectorAll('.walkthrough-tab-content');
        allTabContents.forEach(tab => {
            tab.classList.remove('active');
            tab.style.display = 'none'; // Extra safety
        });
        
        // 2. Remove active class from ALL buttons
        const allTabButtons = document.querySelectorAll('.walkthrough-tab-button');
        allTabButtons.forEach(btn => {
            btn.classList.remove('active');
        });
        
        // 3. Show the target tab content
        const targetTab = document.getElementById(`walkthrough-${tabName}`);
        if (targetTab) {
            targetTab.classList.add('active');
            targetTab.style.display = 'block'; // Extra safety
            console.log(`✅ Showed tab content: walkthrough-${tabName}`);
        } else {
            console.error(`❌ Tab content not found: walkthrough-${tabName}`);
            return;
        }
        
        // 4. Activate the correct button - FIXED LOGIC
        const buttonMapping = {
            'summary': '📈 Summary',
            'detailed': '🔍 Detailed Analysis', 
            'comparison': '⚖️ Tier Comparison'
        };
        
        const targetButtonText = buttonMapping[tabName];
        if (targetButtonText) {
            allTabButtons.forEach(btn => {
                if (btn.textContent.trim() === targetButtonText) {
                    btn.classList.add('active');
                    console.log(`✅ Activated button: ${targetButtonText}`);
                }
            });
        }
        
        console.log(`✅ Successfully switched to walkthrough tab: ${tabName}`);
        
    } catch (error) {
        console.error('❌ Tab switch error:', error);
        
        // Emergency fallback - show summary tab
        const summaryTab = document.getElementById('walkthrough-summary');
        const summaryButton = document.querySelector('.walkthrough-tab-button');
        
        if (summaryTab && summaryButton) {
            // Hide all others
            document.querySelectorAll('.walkthrough-tab-content').forEach(tab => {
                tab.classList.remove('active');
                tab.style.display = 'none';
            });
            document.querySelectorAll('.walkthrough-tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show summary
            summaryTab.classList.add('active');
            summaryTab.style.display = 'block';
            summaryButton.classList.add('active');
            
            console.log('🚨 Emergency fallback: Switched to summary tab');
        }
    }
}



// ADD this helper function:
function updateTabWithTierInfo(tabName, tabElement) {
    // Simplified - just add a subtle indicator
    if (!tabElement.querySelector('.live-indicator')) {
        const indicator = document.createElement('div');
        indicator.className = 'live-indicator';
        indicator.style.cssText = `
            position: absolute;
            top: 5px;
            right: 5px;
            width: 8px;
            height: 8px;
            background: #28a745;
            border-radius: 50%;
            opacity: 0.7;
        `;
        tabElement.style.position = 'relative';
        tabElement.appendChild(indicator);
    }
}
 
// ✅ DEBUG: Test function to verify tabs work
function testAllTabs() {
    console.log('🧪 Testing all walkthrough tabs...');
    
    const tabs = ['summary', 'detailed', 'comparison'];
    let currentIndex = 0;
    
    function testNextTab() {
        if (currentIndex < tabs.length) {
            const tabName = tabs[currentIndex];
            console.log(`Testing tab: ${tabName}`);
            showWalkthroughTab(tabName);
            currentIndex++;
            setTimeout(testNextTab, 1000); // 1 second delay
        } else {
            console.log('✅ All tabs tested! Returning to summary...');
            showWalkthroughTab('summary');
        }
    }
    
    testNextTab();
}

// Call this from console to test: testAllTabs()

// Throttled export functions to prevent UI blocking - PRESERVED ALL FUNCTIONALITY
// Enhanced throttled export functions with memory management
let lastExportTime = 0;
const exportThrottle = 1000; // 1 second throttle
let exportInProgress = false;

async function exportWalkthroughResults(format) {
    try {
        // Enhanced throttling and progress checking
        const now = Date.now();
        if (now - lastExportTime < exportThrottle) {
            console.log('Export throttled - please wait');
            return;
        }
        
        if (exportInProgress) {
            console.log('Export already in progress - please wait');
            return;
        }
        
        if (window.immediateStop) return;
        
        exportInProgress = true;
        lastExportTime = now;

        console.log(`Exporting walkthrough results as ${format}`);
        
        // Add yield point before calling TypeScript implementation
        await new Promise(resolve => setTimeout(resolve, 0));
        
        // Enhanced implementation check
        if (typeof window.exportWalkthroughResultsImpl === 'function') {
            await window.exportWalkthroughResultsImpl(format);
            console.log(`✅ Export completed: ${format}`);
        } else {
            console.warn('Export implementation not available - may still be loading');
        }
        
    } catch (error) {
        console.error('Export failed:', error);
    } finally {
        exportInProgress = false;
    }
}

async function exportWalkthroughSummary() {
    try {
        // Enhanced throttling and progress checking
        const now = Date.now();
        if (now - lastExportTime < exportThrottle) {
            console.log('Export throttled - please wait');
            return;
        }
        
        if (exportInProgress) {
            console.log('Export already in progress - please wait');
            return;
        }
        
        if (window.immediateStop) return;
        
        exportInProgress = true;
        lastExportTime = now;

        console.log('Exporting walkthrough summary');
        
        // Add yield point before calling TypeScript implementation
        await new Promise(resolve => setTimeout(resolve, 0));
        
        // Enhanced implementation check
        if (typeof window.exportWalkthroughSummaryImpl === 'function') {
            await window.exportWalkthroughSummaryImpl();
            console.log('✅ Summary export completed');
        } else {
            console.warn('Export summary implementation not available - may still be loading');
        }
        
    } catch (error) {
        console.error('Export summary failed:', error);
    } finally {
        exportInProgress = false;
    }
}

// Enhanced Unified Execution Functions
async function startUnifiedExecution() {
    try {
        console.log('🚀 Starting unified MCD research framework execution');
        
        // Show unified progress
        // ENHANCED: Show unified progress with trial details
const unifiedProgress = document.getElementById('unifiedProgress');
const unifiedProgressText = document.getElementById('unifiedProgressText');
const unifiedProgressBar = document.getElementById('unifiedProgressBar');

if (unifiedProgress) {
    unifiedProgress.style.display = 'block';
    unifiedProgressText.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <span>Initializing unified execution...</span>
            <span style="font-size: 0.8rem; opacity: 0.8;">Phase 1/3</span>
        </div>
        <div style="font-size: 0.8rem; opacity: 0.7; margin-top: 4px;" id="currentTaskDetail">
            Preparing T1-T10 systematic tests...
        </div>
    `;
    unifiedProgressBar.style.width = '10%';
}

// ENHANCED: Add global progress update function
window.updateUnifiedProgress = (phase, current, total, taskDetail) => {
    try {
        const progressText = document.getElementById('unifiedProgressText');
        const progressBar = document.getElementById('unifiedProgressBar');
        const taskDetailElement = document.getElementById('currentTaskDetail');
        
        if (progressText && progressBar) {
            const percentage = Math.round((current / total) * 100);
            const phaseNames = {
                1: 'T1-T10 Tests',
                2: 'Domain Walkthroughs',
                3: 'Cross-Analysis'
            };
            
            progressText.querySelector('span').textContent = 
                `${phaseNames[phase] || 'Processing'} - ${current}/${total}`;
            progressBar.style.width = `${Math.max(10, percentage)}%`;
            
            if (taskDetailElement && taskDetail) {
                taskDetailElement.textContent = taskDetail;
            }
        }
    } catch (error) {
        console.error('Progress update failed:', error);
    }
};

        
        // Update button states
        const startBtn = document.getElementById('startUnifiedExecution');
        const stopBtn = document.getElementById('stopUnifiedExecution');
        if (startBtn) startBtn.disabled = true;
        if (stopBtn) {
            stopBtn.disabled = false;
            stopBtn.style.display = 'inline-block';
        }
        
        // Check if unified execution function is available
        if (typeof window.startUnifiedExecution === 'function') {
            await window.startUnifiedExecution();
        } else {
            console.warn('Unified execution implementation not yet loaded');
            throw new Error('Unified execution system not ready');
        }
        
    } catch (error) {
        console.error('Unified execution failed:', error);
        alert(`Unified execution failed: ${error.message}`);
        resetUnifiedExecutionUI();
    }
}

function stopUnifiedExecution() {
    try {
        console.log('🛑 Stopping unified execution');
        
        // Call implementation if available
        if (typeof window.stopUnifiedExecution === 'function') {
            window.stopUnifiedExecution();
        }
        
        // Reset UI
        resetUnifiedExecutionUI();
        
    } catch (error) {
        console.error('Error stopping unified execution:', error);
        resetUnifiedExecutionUI();
    }
}

function resetUnifiedExecutionUI() {
    const startBtn = document.getElementById('startUnifiedExecution');
    const stopBtn = document.getElementById('stopUnifiedExecution');
    const unifiedProgress = document.getElementById('unifiedProgress');
    
    if (startBtn) startBtn.disabled = false;
    if (stopBtn) {
        stopBtn.disabled = true;
        stopBtn.style.display = 'none';
    }
    if (unifiedProgress) unifiedProgress.style.display = 'none';
}
// ADD these bridge functions to match HTML calls with TypeScript exports
window.exportWalkthroughResults = async function(format) {
    try {
        if (format === 'json' && typeof window.exportWalkthroughJSON === 'function') {
            await window.exportWalkthroughJSON();
        } else if (format === 'csv' && typeof window.exportWalkthroughCSV === 'function') {
            await window.exportWalkthroughCSV();
        } else {
            console.error(`Export format '${format}' not supported or function not available`);
        }
    } catch (error) {
        console.error('Export failed:', error);
    }
};

// Add the missing summary function
window.exportWalkthroughSummary = async function() {
    try {
        // This will need to be implemented in your TypeScript code
        if (typeof window.exportWalkthroughSummaryImpl === 'function') {
            await window.exportWalkthroughSummaryImpl();
        } else {
            console.warn('Summary export not yet implemented');
            alert('Summary export feature coming soon!');
        }
    } catch (error) {
        console.error('Summary export failed:', error);
    }
};

// Enhanced Export Function
async function exportUnifiedAnalysis() {
    try {
        console.log('📋 Exporting unified analysis report');
        
        if (typeof window.exportUnifiedAnalysisImpl === 'function') {
            await window.exportUnifiedAnalysisImpl();
        } else {
            console.warn('Unified analysis export not yet available');
        }
        
    } catch (error) {
        console.error('Export failed:', error);
        alert(`Export failed: ${error.message}`);
    }
}

// Enhanced Status Update Functions
function updateFrameworkStatus(framework, status, details) {
    try {
        const statusElement = document.getElementById(`${framework}Status`);
        if (statusElement) {
            const icons = {
                ready: framework === 't1t10' ? '📊' : '🎯',
                running: '🔄',
                completed: '✅',
                error: '❌'
            };
            
            const icon = icons[status] || '⚪';
            const frameworkName = framework === 't1t10' ? 'T1-T10' : 'Chapter 7';
            const detailsText = details ? ` (${details})` : '';
            
            statusElement.textContent = `${icon} ${frameworkName}: ${status}${detailsText}`;
            
            // Update CSS classes
            statusElement.className = `framework-status ${status}`;
        }
    } catch (error) {
        console.error('Error updating framework status:', error);
    }
}
// ADD this function after the existing functions, before the final status report
function scrollToDetailedResults() {
    try {
        const container = document.getElementById('detailedResultsContainer');
        if (container) {
            container.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
            });
            console.log('✅ Scrolled to detailed results');
        } else {
            console.warn('⚠️ Detailed results container not found');
        }
    } catch (error) {
        console.error('Error scrolling to detailed results:', error);
    }
}
// ✅ ADD: Safe walkthrough starter function
let walkthroughExecuting = false;

function safeStartWalkthroughs() {
  if (walkthroughExecuting) {
    console.log('🛑 Walkthroughs already executing - click ignored');
    return;
  }
  
  walkthroughExecuting = true;
  
  // ✅ VISUAL FEEDBACK: Add executing class immediately
  const startBtn = document.getElementById('start-walkthroughs-btn');
  if (startBtn) {
    startBtn.classList.add('executing');
  }
  
  try {
    if (window.walkthroughUI && typeof window.walkthroughUI.handleStartWalkthroughs === 'function') {
      window.walkthroughUI.handleStartWalkthroughs();
    } else {
      console.warn('⚠️ Walkthrough system not ready yet');
      alert('Walkthrough system is still loading. Please try again in a moment.');
    }
  } catch (error) {
    console.error('Walkthrough start failed:', error);
    
    // ✅ ERROR HANDLING: Remove executing class on error
    if (startBtn) {
      startBtn.classList.remove('executing');
    }
    walkthroughExecuting = false; // Reset flag immediately on error
    
  } finally {
    // Reset flag after 60 seconds maximum
    setTimeout(() => {
      walkthroughExecuting = false;
      
      // ✅ CLEANUP: Remove executing class when done
      if (startBtn) {
        startBtn.classList.remove('executing');
      }
      
      console.log('🔓 Walkthrough execution lock released');
    }, 60000);
  }
}



// ✅ ADD: Emergency reset function
window.resetWalkthroughLock = function() {
  walkthroughExecuting = false;
  console.log('🔧 Walkthrough lock manually reset');
};

// ============================================
// 🛡️ GLOBAL ERROR HANDLER FOR ASYNC OPERATIONS
// ============================================

// Global error handler for async operations
window.addEventListener('error', function(event) {
    console.warn('🚨 Global error caught:', event.error);
    
    // EMERGENCY LOADING SCREEN REMOVAL ON ERROR
    if (event.error && event.error.message && event.error.message.includes('immediateStop')) {
        console.log('🚨 Loading screen removal triggered by error handler');
        document.getElementById('loadingState')?.remove();
        const mainApp = document.getElementById('mainApp');
        if (mainApp) {
            mainApp.style.display = 'block';
        }
    }
    
    // Don't let errors crash the application
    return true;
});

window.addEventListener('unhandledrejection', function(event) {
    console.warn('🚨 Unhandled promise rejection:', event.reason);
    // Prevent the default behavior (logging to console)
    event.preventDefault();
});

// FIXED: Global immediate stop flag integration - NO TYPESCRIPT SYNTAX
if (!window.immediateStop) {
    window.immediateStop = false;  // ✅ Pure JavaScript
}

// Helper function to check if operations should continue
function shouldContinueExecution() {
    return !window.immediateStop;
}

// Global function to reset immediate stop flag
function resetImmediateStop() {
    window.immediateStop = false;
    console.log('🔄 Immediate stop flag reset');
}

// Global function to trigger immediate stop
function triggerImmediateStop() {
    window.immediateStop = true;
    console.log('🛑 Immediate stop triggered globally');
}
// ADD this integration helper after the global functions:

// Integration checker for TypeScript modules
const checkModuleIntegration = () => {
    const integrationStatus = {
        testControl: !!window.testControl,
        modelLoader: !!window.modelLoader,
        walkthroughUI: !!window.walkthroughUI,
        buttonHandlers: !!window.startTests,
        evaluator: !!window.EvaluatorIntegration,
        logger: !!window.LoggerManager,
        utils: !!window.UtilsManager,
        driftDetector: !!window.DriftDetectorManager
    };
    
    const readyCount = Object.values(integrationStatus).filter(Boolean).length;
    const totalCount = Object.keys(integrationStatus).length;
    
    console.log(`🔗 Module Integration: ${readyCount}/${totalCount} modules ready`);
    
    if (readyCount >= 6) { // Most critical modules
        console.log('✅ Core modules integrated - system ready');
        return true;
    } else {
        console.log('⚠️ Some modules still loading...');
        Object.entries(integrationStatus).forEach(([module, ready]) => {
            console.log(`  • ${module}: ${ready ? '✅' : '❌'}`);
        });
        return false;
    }
};

// Enhanced initialization with module checking
const enhancedInitialization = async () => {
    try {
        // Wait a bit for modules to load
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        // Check module integration
        const modulesReady = checkModuleIntegration();
        
        if (modulesReady || window.immediateStop) {
            safeInitialization();
        } else {
            // Wait a bit more for modules
            console.log('⏳ Waiting for additional modules...');
            (window.safeSetTimeout || setTimeout)(() => {
                checkModuleIntegration();
                safeInitialization();
            }, 2000);
        }
        
    } catch (error) {
        console.error('Enhanced initialization failed:', error);
        safeInitialization(); // Fallback to basic initialization
    }
};

// EMERGENCY: Force loading screen removal after 5 seconds
// Enhanced emergency system with proper cleanup
let emergencyCleanupTimeout = null;

// REPLACE the complex emergency system with this simplified version:
const setupEmergencySystem = () => {
    // Clear any existing emergency timeout
    if (window.emergencyCleanupTimeout) {
        clearTimeout(window.emergencyCleanupTimeout);
    }
    
    // Simple emergency fallback after 6 seconds - FIXED
    window.emergencyCleanupTimeout = window.originalSetTimeout ? 
        window.originalSetTimeout.call(window, () => {
            try {
                const loading = document.getElementById('loadingState');
                const mainApp = document.getElementById('mainApp');
                
                if (loading && loading.style.display !== 'none') {
                    console.log('🚨 EMERGENCY: Force removing loading screen after 6 seconds');
                    loading.style.display = 'none';
                }
                
                if (mainApp && mainApp.style.display !== 'block') {
                    mainApp.style.display = 'block';
                }
                
                window.emergencyCleanupTimeout = null;
                
            } catch (error) {
                console.error('Emergency system failed:', error);
            }
        }, 6000) :
        (window.safeSetTimeout || setTimeout)(() => {
            // fallback using native setTimeout
            try {
                const loading = document.getElementById('loadingState');
                const mainApp = document.getElementById('mainApp');
                
                if (loading && loading.style.display !== 'none') {
                    loading.style.display = 'none';
                }
                if (mainApp && mainApp.style.display !== 'block') {
                    mainApp.style.display = 'block';
                }
                window.emergencyCleanupTimeout = null;
            } catch (error) {
                console.error('Emergency fallback failed:', error);
            }
        }, 6000);
};



// Initialize emergency system
setupEmergencySystem();

// Cleanup function for page unload
// REPLACE the performPageCleanup function with this corrected version:
const performPageCleanup = () => {
    try {
        // Clear all timeouts using window scope
        if (window.initializationTimeout) {
            clearTimeout(window.initializationTimeout);
            window.initializationTimeout = null;
        }
        if (window.emergencyTimeout) {
            clearTimeout(window.emergencyTimeout);
            window.emergencyTimeout = null;
        }
        if (window.emergencyCleanupTimeout) {
            clearTimeout(window.emergencyCleanupTimeout);
            window.emergencyCleanupTimeout = null;
        }
        
        // Reset flags
        window.immediateStop = false;
        
        console.log('🧹 Page cleanup completed');
        
    } catch (error) {
        console.warn('Page cleanup failed:', error);
    }
};


// Add cleanup event listener
window.addEventListener('beforeunload', performPageCleanup);


// Export helper functions to window for debugging
window.shouldContinueExecution = shouldContinueExecution;
window.resetImmediateStop = resetImmediateStop;
window.triggerImmediateStop = triggerImmediateStop;

// MANUAL OVERRIDE FUNCTION for testing
// Enhanced manual override function with comprehensive recovery
// REPLACE the forceShowApp function with this enhanced version:
window.forceShowApp = function() {
    try {
        console.log('🔧 Manual override: Force showing main app');
        
        // Clear all timeouts to prevent conflicts
        if (window.initializationTimeout) clearTimeout(window.initializationTimeout);
        if (window.emergencyTimeout) clearTimeout(window.emergencyTimeout);
        if (window.emergencyCleanupTimeout) clearTimeout(window.emergencyCleanupTimeout);
        
        // Reset timeout references
        window.initializationTimeout = null;
        window.emergencyTimeout = null;
        window.emergencyCleanupTimeout = null;
        
        // Force remove loading screen
        const loading = document.getElementById('loadingState');
        if (loading) loading.remove();
        
        // Force show main app
        const mainApp = document.getElementById('mainApp');
        if (mainApp) mainApp.style.display = 'block';
        
        // Reset flags
        window.immediateStop = false;
        
        // Check module integration status
        setTimeout(checkModuleIntegration, 500);
        
        console.log('✅ Manual override completed successfully');
        
    } catch (error) {
        console.error('Manual override failed:', error);
        // Last resort DOM manipulation
        try {
            const elements = document.querySelectorAll('#mainApp');
            elements.forEach(el => el.style.display = 'block');
            const loading = document.querySelectorAll('#loadingState');
            loading.forEach(el => el.remove());
        } catch (lastResortError) {
            console.error('Last resort failed:', lastResortError);
        }
    }
};



console.log('🔧 Loading screen removal script loaded successfully');

// ADD final integration status report
(window.safeSetTimeout || setTimeout)(() => {
    console.log('🎉 HTML Integration Status:');
    console.log('  ✅ Simplified initialization system');
    console.log('  ✅ Module integration checking');
    console.log('  ✅ Emergency fallback system');
    console.log('  ✅ Memory cleanup system');
    console.log('  ✅ TypeScript module coordination');
    console.log('  ✅ Walkthrough UI integration');
    console.log('🚀 MCD Simulation Runner HTML fully integrated!');
}, 2000);

</script>



</body>
</html>
